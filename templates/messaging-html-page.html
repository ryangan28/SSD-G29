{# Inherit base.html layout #}
{% extends "base.html" %}

{# Website title #}
{% block title %}Messages - Safe Companions{% endblock %}

{# Main content #}
{% block content %}
<div class="container-fluid mt-3">
    <div class="row" style="height: calc(100vh - 100px);">
        {# Conversations List #}
        <div class="col-md-3 border-end">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Messages</h5>
                <span class="badge bg-primary" id="unread-count">{{ unread_count }}</span>
            </div>
            
            {# Search Conversations #}
            <div class="mb-3">
                <input type="text" class="form-control" placeholder="Search conversations..." 
                       onkeyup="searchConversations(this.value)">
            </div>
            
            {# Conversations List #}
            <div class="list-group" id="conversations-list" style="overflow-y: auto; max-height: calc(100vh - 250px);">
                {% for conversation in conversations %}
                <a href="#" class="list-group-item list-group-item-action {{ 'active' if conversation.id == active_conversation_id else '' }}"
                   onclick="loadConversation({{ conversation.id }})" data-conversation-id="{{ conversation.id }}">
                    <div class="d-flex align-items-center">
                        <img src="{{ conversation.other_user_photo }}" class="rounded-circle me-2" 
                             width="40" height="40" alt="{{ conversation.other_user_name }}">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-1">{{ conversation.other_user_name }}</h6>
                                <small class="text-muted">{{ conversation.last_message_time }}</small>
                            </div>
                            <p class="mb-0 text-truncate small {{ 'fw-bold' if conversation.has_unread else 'text-muted' }}">
                                {{ conversation.last_message }}
                            </p>
                        </div>
                        {% if conversation.has_unread %}
                        <span class="badge bg-danger rounded-pill ms-2">{{ conversation.unread_count }}</span>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        
        {# Chat Area #}
        <div class="col-md-6 d-flex flex-column">
            {# Chat Header #}
            <div class="border-bottom p-3" id="chat-header">
                {% if active_conversation %}
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <img src="{{ active_conversation.other_user_photo }}" class="rounded-circle me-2" 
                             width="40" height="40" alt="{{ active_conversation.other_user_name }}">
                        <div>
                            <h6 class="mb-0">{{ active_conversation.other_user_name }}</h6>
                            <small class="text-muted">
                                <i class="bi bi-shield-check text-success"></i> End-to-end encrypted
                            </small>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="showBookingInfo()">
                            <i class="bi bi-info-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="reportUser()">
                            <i class="bi bi-flag"></i>
                        </button>
                    </div>
                </div>
                {% else %}
                <p class="text-muted text-center mb-0">Select a conversation to start messaging</p>
                {% endif %}
            </div>
            
            {# Messages Area #}
            <div class="flex-grow-1 p-3" id="messages-area" style="overflow-y: auto; background-color: #f8f9fa;">
                {% if active_conversation %}
                    <div id="messages-container">
                        {% for message in messages %}
                        <div class="d-flex {{ 'justify-content-end' if message.is_sender else '' }} mb-3">
                            <div class="max-w-75">
                                <div class="card {{ 'bg-primary text-white' if message.is_sender else '' }}">
                                    <div class="card-body p-2">
                                        <p class="mb-1">{{ message.content }}</p>
                                        <small class="{{ 'text-white-50' if message.is_sender else 'text-muted' }}">
                                            {{ message.timestamp }}
                                            {% if message.is_sender %}
                                                {% if message.is_read %}
                                                    <i class="bi bi-check2-all"></i>
                                                {% else %}
                                                    <i class="bi bi-check2"></i>
                                                {% endif %}
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {# Typing Indicator #}
                    <div id="typing-indicator" class="d-none mb-2">
                        <small class="text-muted">
                            <i class="bi bi-three-dots"></i> {{ active_conversation.other_user_name }} is typing...
                        </small>
                    </div>
                {% else %}
                    <div class="text-center text-muted mt-5">
                        <i class="bi bi-chat-dots" style="font-size: 4rem;"></i>
                        <p class="mt-3">No conversation selected</p>
                    </div>
                {% endif %}
            </div>
            
            {# Message Input #}
            {% if active_conversation %}
            <div class="border-top p-3">
                <form onsubmit="sendMessage(event)" id="message-form">
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" type="button" onclick="showEmojiPicker()">
                            <i class="bi bi-emoji-smile"></i>
                        </button>
                        <input type="text" class="form-control" id="message-input" 
                               placeholder="Type a message..." autocomplete="off">
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
        
        {# Right Sidebar - Actions/Info #}
        <div class="col-md-3 border-start">
            {# Tab Navigation #}
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#info-tab">
                        Info
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#feedback-tab">
                        Feedback
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#report-tab">
                        Report
                    </button>
                </li>
            </ul>
            
            {# Tab Content #}
            <div class="tab-content p-3">
                {# Info Tab #}
                <div class="tab-pane fade show active" id="info-tab">
                    {% if active_conversation %}
                    <h6>Booking Information</h6>
                    <p class="small mb-2"><strong>Booking ID:</strong> #{{ active_conversation.booking_id }}</p>
                    <p class="small mb-2"><strong>Date:</strong> {{ active_conversation.booking_date }}</p>
                    <p class="small mb-2"><strong>Time:</strong> {{ active_conversation.booking_time }}</p>
                    <p class="small mb-2"><strong>Duration:</strong> {{ active_conversation.booking_duration }} hours</p>
                    <p class="small mb-3"><strong>Status:</strong> 
                        <span class="badge bg-{{ active_conversation.booking_status_color }}">
                            {{ active_conversation.booking_status }}
                        </span>
                    </p>
                    
                    <h6 class="mt-4">Security Info</h6>
                    <div class="alert alert-info small">
                        <i class="bi bi-shield-lock"></i> Messages are end-to-end encrypted using WebCrypto API with X25519 key exchange and AES-GCM encryption.
                    </div>
                    {% else %}
                    <p class="text-muted">Select a conversation to view details</p>
                    {% endif %}
                </div>
                
                {# Feedback Tab #}
                <div class="tab-pane fade" id="feedback-tab">
                    {% if can_leave_feedback %}
                    <h6>Leave Feedback</h6>
                    <form onsubmit="submitFeedback(event)">
                        <div class="mb-3">
                            <label class="form-label">Rating</label>
                            <div class="star-rating">
                                {% for i in range(1, 6) %}
                                <i class="bi bi-star star-icon" data-rating="{{ i }}" onclick="setRating({{ i }})"></i>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="feedback-comment" class="form-label">Comment</label>
                            <textarea class="form-control" id="feedback-comment" rows="4" 
                                      placeholder="Share your experience..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Submit Feedback</button>
                    </form>
                    {% elif has_feedback %}
                    <h6>Your Feedback</h6>
                    <div class="mb-2">
                        {% for i in range(1, 6) %}
                            <i class="bi bi-star{{ '-fill' if i <= feedback_rating else '' }} text-warning"></i>
                        {% endfor %}
                    </div>
                    <p class="small">{{ feedback_comment }}</p>
                    <small class="text-muted">Submitted on {{ feedback_date }}</small>
                    {% else %}
                    <p class="text-muted">Feedback can only be left after the booking is completed.</p>
                    {% endif %}
                </div>
                
                {# Report Tab #}
                <div class="tab-pane fade" id="report-tab">
                    <h6>Report User</h6>
                    <form onsubmit="submitReport(event)">
                        <div class="mb-3">
                            <label for="report-reason" class="form-label">Reason</label>
                            <select class="form-select" id="report-reason" required>
                                <option value="">Select a reason...</option>
                                <option value="inappropriate_messages">Inappropriate messages</option>
                                <option value="harassment">Harassment or abuse</option>
                                <option value="spam">Spam or solicitation</option>
                                <option value="fake_profile">Fake profile</option>
                                <option value="no_show">No-show for booking</option>
                                <option value="safety_concern">Safety concern</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="report-details" class="form-label">Details</label>
                            <textarea class="form-control" id="report-details" rows="4" 
                                      placeholder="Please provide details..." required></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="block-user">
                            <label class="form-check-label" for="block-user">
                                Block this user
                            </label>
                        </div>
                        <button type="submit" class="btn btn-danger w-100">Submit Report</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{# Emoji Picker Modal #}
<div class="modal fade" id="emojiModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body">
                <div class="emoji-grid">
                    {% set emojis = ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üòç', 'ü§ó', 'üòò', 'ü•∞', 'üòé', 'ü§î', 'üòÖ', 'üòâ', 'üôè', 'üíï', 'üòÅ', 'üî•', 'üíØ', 'üéâ', 'üò¢', 'üò≠'] %}
                    {% for emoji in emojis %}
                    <span class="emoji-item" onclick="insertEmoji('{{ emoji }}')">{{ emoji }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// WebSocket connection for real-time messaging
let socket = null;
let currentConversationId = {{ active_conversation_id or 'null' }};
let encryptionKeys = {};

// Initialize WebSocket connection
function initializeWebSocket() {
    socket = new WebSocket('wss://' + window.location.host + '/ws/chat');
    
    socket.onopen = function() {
        console.log('WebSocket connected');
        if (currentConversationId) {
            socket.send(JSON.stringify({
                type: 'join',
                conversation_id: currentConversationId
            }));
        }
    };
    
    socket.onmessage = async function(event) {
        const data = JSON.parse(event.data);
        
        switch(data.type) {
            case 'message':
                await handleIncomingMessage(data);
                break;
            case 'typing':
                handleTypingIndicator(data);
                break;
            case 'read':
                handleReadReceipt(data);
                break;
            case 'key_exchange':
                await handleKeyExchange(data);
                break;
        }
    };
    
    socket.onclose = function() {
        console.log('WebSocket disconnected');
        // Attempt to reconnect after 3 seconds
        setTimeout(initializeWebSocket, 3000);
    };
}

// Initialize encryption for conversation
async function initializeEncryption(conversationId) {
    // Generate key pair for this conversation
    const keyPair = await window.crypto.subtle.generateKey(
        {
            name: "ECDH",
            namedCurve: "P-256"
        },
        true,
        ["deriveKey"]
    );
    
    // Export public key
    const publicKey = await window.crypto.subtle.exportKey("raw", keyPair.publicKey);
    
    // Store key pair
    encryptionKeys[conversationId] = {
        keyPair: keyPair,
        publicKey: publicKey
    };
    
    // Send public key to other party
    socket.send(JSON.stringify({
        type: 'key_exchange',
        conversation_id: conversationId,
        public_key: btoa(String.fromCharCode(...new Uint8Array(publicKey)))
    }));
}

// Handle key exchange
async function handleKeyExchange(data) {
    const conversationId = data.conversation_id;
    const otherPublicKey = Uint8Array.from(atob(data.public_key), c => c.charCodeAt(0));
    
    // Import other party's public key
    const importedKey = await window.crypto.subtle.importKey(
        "raw",
        otherPublicKey,
        {
            name: "ECDH",
            namedCurve: "P-256"
        },
        false,
        []
    );
    
    // Derive shared secret
    const sharedSecret = await window.crypto.subtle.deriveKey(
        {
            name: "ECDH",
            public: importedKey
        },
        encryptionKeys[conversationId].keyPair.privateKey,
        {
            name: "AES-GCM",
            length: 256
        },
        false,
        ["encrypt", "decrypt"]
    );
    
    encryptionKeys[conversationId].sharedSecret = sharedSecret;
}

// Encrypt message
async function encryptMessage(message, conversationId) {
    const encoder = new TextEncoder();
    const data = encoder.encode(message);
    
    // Generate IV
    const iv = window.crypto.getRandomValues(new Uint8Array(12));
    
    // Encrypt
    const encrypted = await window.crypto.subtle.encrypt(
        {
            name: "AES-GCM",
            iv: iv
        },
        encryptionKeys[conversationId].sharedSecret,
        data
    );
    
    return {
        encrypted: btoa(String.fromCharCode(...new Uint8Array(encrypted))),
        iv: btoa(String.fromCharCode(...iv))
    };
}

// Decrypt message
async function decryptMessage(encryptedData, conversationId) {
    const encrypted = Uint8Array.from(atob(encryptedData.encrypted), c => c.charCodeAt(0));
    const iv = Uint8Array.from(atob(encryptedData.iv), c => c.charCodeAt(0));
    
    const decrypted = await window.crypto.subtle.decrypt(
        {
            name: "AES-GCM",
            iv: iv
        },
        encryptionKeys[conversationId].sharedSecret,
        encrypted
    );
    
    const decoder = new TextDecoder();
    return decoder.decode(decrypted);
}

// Send message
async function sendMessage(event) {
    event.preventDefault();
    
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message || !currentConversationId) return;
    
    // Encrypt message if encryption is initialized
    let messageData = { content: message };
    if (encryptionKeys[currentConversationId]?.sharedSecret) {
        messageData = await encryptMessage(message, currentConversationId);
        messageData.encrypted = true;
    }
    
    // Send via WebSocket
    socket.send(JSON.stringify({
        type: 'message',
        conversation_id: currentConversationId,
        ...messageData
    }));
    
    // Clear input
    input.value = '';
    
    // Add to UI immediately
    appendMessage({
        content: message,
        is_sender: true,
        timestamp: 'Just now',
        is_read: false
    });
}

// Handle incoming message
async function handleIncomingMessage(data) {
    let content = data.content;
    
    // Decrypt if needed
    if (data.encrypted && encryptionKeys[data.conversation_id]?.sharedSecret) {
        content = await decryptMessage({
            encrypted: data.encrypted,
            iv: data.iv
        }, data.conversation_id);
    }
    
    // Add to UI if it's for current conversation
    if (data.conversation_id === currentConversationId) {
        appendMessage({
            content: content,
            is_sender: false,
            timestamp: data.timestamp,
            message_id: data.message_id
        });
        
        // Send read receipt
        socket.send(JSON.stringify({
            type: 'read',
            conversation_id: currentConversationId,
            message_id: data.message_id
        }));
    } else {
        // Update unread count for other conversations
        updateUnreadCount(data.conversation_id);
    }
}

// Append message to UI
function appendMessage(message) {
    const container = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `d-flex ${message.is_sender ? 'justify-content-end' : ''} mb-3`;
    messageDiv.innerHTML = `
        <div class="max-w-75">
            <div class="card ${message.is_sender ? 'bg-primary text-white' : ''}">
                <div class="card-body p-2">
                    <p class="mb-1">${escapeHtml(message.content)}</p>
                    <small class="${message.is_sender ? 'text-white-50' : 'text-muted'}">
                        ${message.timestamp}
                        ${message.is_sender ? `<i class="bi bi-check2${message.is_read ? '-all' : ''}"></i>` : ''}
                    </small>
                </div>
            </div>
        </div>
    `;
    container.appendChild(messageDiv);
    
    // Scroll to bottom
    const messagesArea = document.getElementById('messages-area');
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

// Load conversation
async function loadConversation(conversationId) {
    currentConversationId = conversationId;
    
    // Update active state in list
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-conversation-id="${conversationId}"]`).classList.add('active');
    
    // Initialize encryption if needed
    if (!encryptionKeys[conversationId]) {
        await initializeEncryption(conversationId);
    }
    
    // Load conversation via AJAX
    window.location.href = `/messaging.html?conversation_id=${conversationId}`;
}

// Typing indicator
let typingTimer;
document.getElementById('message-input')?.addEventListener('input', function() {
    clearTimeout(typingTimer);
    
    // Send typing indicator
    socket.send(JSON.stringify({
        type: 'typing',
        conversation_id: currentConversationId,
        typing: true
    }));
    
    // Stop typing after 2 seconds
    typingTimer = setTimeout(() => {
        socket.send(JSON.stringify({
            type: 'typing',
            conversation_id: currentConversationId,
            typing: false
        }));
    }, 2000);
});

// Handle typing indicator
function handleTypingIndicator(data) {
    if (data.conversation_id === currentConversationId && !data.is_self) {
        const indicator = document.getElementById('typing-indicator');
        if (data.typing) {
            indicator.classList.remove('d-none');
        } else {
            indicator.classList.add('d-none');
        }
    }
}

// Handle read receipts
function handleReadReceipt(data) {
    // Update UI to show message as read
    // Implementation depends on how messages are stored in DOM
}

// Search conversations
function searchConversations(query) {
    const items = document.querySelectorAll('#conversations-list .list-group-item');
    items.forEach(item => {
        const name = item.querySelector('h6').textContent.toLowerCase();
        if (name.includes(query.toLowerCase())) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Show emoji picker
function showEmojiPicker() {
    const modal = new bootstrap.Modal(document.getElementById('emojiModal'));
    modal.show();
}

// Insert emoji
function insertEmoji(emoji) {
    const input = document.getElementById('message-input');
    input.value += emoji;
    input.focus();
    bootstrap.Modal.getInstance(document.getElementById('emojiModal')).hide();
}

// Set rating
function setRating(rating) {
    document.querySelectorAll('.star-icon').forEach((star, index) => {
        if (index < rating) {
            star.classList.remove('bi-star');
            star.classList.add('bi-star-fill', 'text-warning');
        } else {
            star.classList.remove('bi-star-fill', 'text-warning');
            star.classList.add('bi-star');
        }
    });
}

// Submit feedback
function submitFeedback(event) {
    event.preventDefault();
    
    const rating = document.querySelectorAll('.star-icon.bi-star-fill').length;
    const comment = document.getElementById('feedback-comment').value;
    
    fetch(`/api/bookings/${currentConversationId}/feedback`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            rating: rating,
            comment: comment
        })
    }).then(response => {
        if (response.ok) {
            alert('Feedback submitted successfully!');
            location.reload();
        }
    });
}

// Submit report
function submitReport(event) {
    event.preventDefault();
    
    const reason = document.getElementById('report-reason').value;
    const details = document.getElementById('report-details').value;
    const blockUser = document.getElementById('block-user').checked;
    
    fetch('/api/reports', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            reported_user_id: {{ active_conversation.other_user_id if active_conversation else 'null' }},
            conversation_id: currentConversationId,
            reason: reason,
            details: details,
            block_user: blockUser
        })
    }).then(response => {
        if (response.ok) {
            alert('Report submitted. Our team will review it shortly.');
            if (blockUser) {
                window.location.href = '/messaging.html';
            }
        }
    });
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    initializeWebSocket();
});
</script>

<style>
/* Message styling */
.max-w-75 {
    max-width: 75%;
}

/* Star rating */
.star-icon {
    font-size: 1.5rem;
    cursor: pointer;
    color: #ddd;
}

.star-icon:hover,
.star-icon.bi-star-fill {
    color: #ffc107;
}

/* Emoji picker */
.emoji-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 5px;
}

.emoji-item {
    font-size: 1.5rem;
    cursor: pointer;
    text-align: center;
    padding: 5px;
    border-radius: 5px;
}

.emoji-item:hover {
    background-color: #f0f0f0;
}

/* Conversation list */
.list-group-item.active {
    background-color: #e9ecef;
    border-color: #e9ecef;
    color: #212529;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .col-md-3 {
        display: none;
    }
    
    .col-md-6 {
        max-width: 100%;
        flex: 0 0 100%;
    }
}
</style>
{% endblock %}