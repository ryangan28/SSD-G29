{# Inherit base.html layout #}
{% extends "base.html" %}

{# Website title #}
{% block title %}Authentication - Safe Companions{% endblock %}

{# Main content #}
{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            {# Dynamic content based on mode #}
            <div id="auth-container">
                {# Login Form (Default) #}
                <div id="login-form" class="auth-form">
                    <h2 class="text-center mb-4">Welcome Back</h2>
                    <form method="post" action="{{ url_for('login') }}">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" id="login-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Password</label>
                            <input type="password" name="password" class="form-control" id="login-password" required>
                        </div>
                        <div class="mb-3">
                            <div class="g-recaptcha" data-sitekey="your-site-key"></div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" name="remember" class="form-check-input" id="remember-me">
                                <label class="form-check-label" for="remember-me">Remember me</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                        <div class="text-center mt-3">
                            <a href="#" onclick="showForm('reset')">Forgot Password?</a> | 
                            <a href="#" onclick="showForm('register')">Create Account</a>
                        </div>
                    </form>
                </div>

                {# Registration Form #}
                <div id="register-form" class="auth-form" style="display: none;">
                    <h2 class="text-center mb-4">Create Account</h2>
                    <form method="post" action="{{ url_for('register') }}" onsubmit="return validateRegistration()">
                        <div class="mb-3">
                            <label class="form-label">I want to be a:</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="role" id="role-seeker" value="seeker" required>
                                <label class="btn btn-outline-primary" for="role-seeker">Seeker</label>
                                <input type="radio" class="btn-check" name="role" id="role-escort" value="escort" required>
                                <label class="btn btn-outline-primary" for="role-escort">Escort</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reg-email" class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" id="reg-email" required>
                            <div class="invalid-feedback">Email already exists</div>
                        </div>
                        <div class="mb-3">
                            <label for="reg-dob" class="form-label">Date of Birth</label>
                            <input type="date" name="dob" class="form-control" id="reg-dob" required onchange="checkAge()">
                            <div class="invalid-feedback">You must be 18 or older to register</div>
                        </div>
                        <div class="mb-3">
                            <label for="reg-password" class="form-label">Password</label>
                            <input type="password" name="password" class="form-control" id="reg-password" required pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{12,}$">
                            <small class="form-text text-muted">Minimum 12 characters, including uppercase, lowercase, number, and special character</small>
                        </div>
                        <div class="mb-3">
                            <label for="reg-confirm-password" class="form-label">Confirm Password</label>
                            <input type="password" name="confirm_password" class="form-control" id="reg-confirm-password" required>
                        </div>
                        <div class="mb-3">
                            <div class="g-recaptcha" data-sitekey="your-site-key"></div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="terms" required>
                                <label class="form-check-label" for="terms">
                                    I agree to the <a href="/legal.html#terms" target="_blank">Terms of Service</a> and 
                                    <a href="/legal.html#privacy" target="_blank">Privacy Policy</a>
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Create Account</button>
                        <div class="text-center mt-3">
                            Already have an account? <a href="#" onclick="showForm('login')">Login</a>
                        </div>
                    </form>
                </div>

                {# Password Reset Request Form #}
                <div id="reset-form" class="auth-form" style="display: none;">
                    <h2 class="text-center mb-4">Reset Password</h2>
                    <p class="text-center text-muted">Enter your email address and we'll send you a password reset link.</p>
                    <form method="post" action="{{ url_for('reset_password_request') }}">
                        <div class="mb-3">
                            <label for="reset-email" class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" id="reset-email" required>
                        </div>
                        <div class="mb-3">
                            <div class="g-recaptcha" data-sitekey="your-site-key"></div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Send Reset Link</button>
                        <div class="text-center mt-3">
                            <a href="#" onclick="showForm('login')">Back to Login</a>
                        </div>
                    </form>
                </div>

                {# New Password Form (shown when token is present) #}
                <div id="new-password-form" class="auth-form" style="display: none;">
                    <h2 class="text-center mb-4">Set New Password</h2>
                    <form method="post" action="{{ url_for('reset_password_confirm') }}">
                        <input type="hidden" name="token" id="reset-token" value="">
                        <div class="mb-3">
                            <label for="new-password" class="form-label">New Password</label>
                            <input type="password" name="password" class="form-control" id="new-password" required pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{12,}$">
                            <small class="form-text text-muted">Minimum 12 characters, including uppercase, lowercase, number, and special character</small>
                        </div>
                        <div class="mb-3">
                            <label for="confirm-new-password" class="form-label">Confirm New Password</label>
                            <input type="password" name="confirm_password" class="form-control" id="confirm-new-password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Reset Password</button>
                    </form>
                </div>

                {# Email Verification Message #}
                <div id="verify-email" class="auth-form text-center" style="display: none;">
                    <i class="bi bi-envelope-check" style="font-size: 4rem; color: var(--bs-success);"></i>
                    <h2 class="mt-3">Email Verified!</h2>
                    <p>Your email has been successfully verified.</p>
                    <a href="#" onclick="showForm('login')" class="btn btn-primary">Login Now</a>
                </div>

                {# Account Locked Message #}
                <div id="account-locked" class="auth-form text-center" style="display: none;">
                    <i class="bi bi-lock" style="font-size: 4rem; color: var(--bs-danger);"></i>
                    <h2 class="mt-3">Account Locked</h2>
                    <p>Too many failed login attempts. Your account has been locked for 15 minutes.</p>
                    <p class="text-muted">Please try again at: <span id="unlock-time"></span></p>
                </div>

                {# Session Timeout Message #}
                <div id="session-timeout" class="auth-form text-center" style="display: none;">
                    <i class="bi bi-clock-history" style="font-size: 4rem; color: var(--bs-warning);"></i>
                    <h2 class="mt-3">Session Expired</h2>
                    <p>Your session has expired due to inactivity. Please login again.</p>
                    <a href="#" onclick="showForm('login')" class="btn btn-primary">Login</a>
                </div>
            </div>

            {# Flash Messages #}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>
    </div>
</div>

{# JavaScript for form switching and validation #}
<script>
// Check URL parameters on page load
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const token = urlParams.get('token');
    
    if (mode === 'register') {
        showForm('register');
    } else if (mode === 'reset') {
        if (token) {
            document.getElementById('reset-token').value = token;
            showForm('new-password');
        } else {
            showForm('reset');
        }
    } else if (mode === 'verify' && token) {
        verifyEmail(token);
    } else if (mode === 'locked') {
        showAccountLocked();
    } else if (mode === 'timeout') {
        showForm('session-timeout');
    } else {
        showForm('login');
    }
};

function showForm(formType) {
    // Hide all forms
    document.querySelectorAll('.auth-form').forEach(form => {
        form.style.display = 'none';
    });
    
    // Show selected form
    const formId = formType + '-form';
    const form = document.getElementById(formId) || document.getElementById(formType);
    if (form) {
        form.style.display = 'block';
    }
    
    // Update URL without reload
    const url = new URL(window.location);
    if (formType === 'login') {
        url.searchParams.delete('mode');
    } else {
        url.searchParams.set('mode', formType);
    }
    window.history.pushState({}, '', url);
}

function checkAge() {
    const dob = document.getElementById('reg-dob').value;
    const today = new Date();
    const birthDate = new Date(dob);
    const age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    if (age < 18) {
        document.getElementById('reg-dob').classList.add('is-invalid');
        return false;
    } else {
        document.getElementById('reg-dob').classList.remove('is-invalid');
        return true;
    }
}

function validateRegistration() {
    // Check age
    if (!checkAge()) {
        alert('You must be 18 or older to register.');
        return false;
    }
    
    // Check password match
    const password = document.getElementById('reg-password').value;
    const confirmPassword = document.getElementById('reg-confirm-password').value;
    
    if (password !== confirmPassword) {
        alert('Passwords do not match.');
        return false;
    }
    
    return true;
}

function verifyEmail(token) {
    // In real implementation, this would make an API call
    // For now, just show success message
    showForm('verify-email');
}

function showAccountLocked() {
    showForm('account-locked');
    // Set unlock time to 15 minutes from now
    const unlockTime = new Date();
    unlockTime.setMinutes(unlockTime.getMinutes() + 15);
    document.getElementById('unlock-time').textContent = unlockTime.toLocaleTimeString();
}

// Session timeout warning
let warningTimer;
let logoutTimer;

function resetTimers() {
    clearTimeout(warningTimer);
    clearTimeout(logoutTimer);
    
    // Show warning after 13 minutes
    warningTimer = setTimeout(() => {
        if (confirm('Your session will expire in 2 minutes. Do you want to stay logged in?')) {
            // Extend session
            resetTimers();
        }
    }, 13 * 60 * 1000);
    
    // Auto logout after 15 minutes
    logoutTimer = setTimeout(() => {
        window.location.href = '/auth.html?mode=timeout';
    }, 15 * 60 * 1000);
}

// Start timers if user is logged in
if (document.cookie.includes('session=')) {
    resetTimers();
    // Reset on any user activity
    document.addEventListener('click', resetTimers);
    document.addEventListener('keypress', resetTimers);
}
</script>

{# Google reCAPTCHA #}
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endblock %}